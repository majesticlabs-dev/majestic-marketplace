---
module: User Service
date: 2025-11-10
problem_type: performance_issue
component: model
symptoms:
  - "N+1 query when loading user records"
  - "API response taking >5 seconds"
root_cause: missing_eager_load
framework_version: Rails 7.1.2
resolution_type: code_fix
severity: high
tags: [n-plus-one, eager-loading, performance]

# Discovery fields
lesson_type: antipattern
workflow_phase: [debugging, review]
tech_stack: [rails]
impact: major_time_sink
keywords: [includes, eager_load, preload, has_many, belongs_to, query]
---

# Troubleshooting: N+1 Query in User List API

## Problem

API endpoint for listing users was taking 5+ seconds due to N+1 query pattern - each user triggered a separate query to load associated profile.

## Environment

- Module: User Service
- Framework Version: Rails 7.1.2
- Affected Component: `app/models/user.rb`, `app/controllers/api/v1/users_controller.rb`
- Date: 2025-11-10

## Symptoms

- N+1 query when loading user records
- API response taking >5 seconds
- Database connection pool exhaustion under load
- Bullet gem (if installed) warnings in development

## What Didn't Work

**Attempted Solution 1:** Added pagination
- **Why it failed:** Reduced number of users per request but each user still triggered N+1 for profile

**Attempted Solution 2:** Cached profile data
- **Why it failed:** Cache invalidation complexity, didn't address root cause

## Solution

Added eager loading with `includes` on the User model scope:

**Code changes:**

```ruby
# Before (broken):
class UsersController < ApplicationController
  def index
    @users = User.all
    render json: @users.map { |u| user_with_profile(u) }
  end
end

# After (fixed):
class UsersController < ApplicationController
  def index
    @users = User.includes(:profile).all
    render json: @users.map { |u| user_with_profile(u) }
  end
end
```

Or better, create a scope:

```ruby
# app/models/user.rb
class User < ApplicationRecord
  scope :with_profile, -> { includes(:profile) }
end

# app/controllers/api/v1/users_controller.rb
@users = User.with_profile.all
```

## Why This Works

1. **Root cause:** Rails lazy-loads associations by default. When iterating over users and accessing `user.profile`, Rails issues a separate query for each user.

2. **Solution mechanism:** `includes(:profile)` tells Rails to eager-load profiles in a single query (or two queries with `preload`), reducing N+1 to 2 queries regardless of user count.

3. **When to use which:**
   - `includes`: Default choice, let Rails decide (usually 2 queries)
   - `preload`: Force 2 separate queries (good for large datasets)
   - `eager_load`: Force single LEFT OUTER JOIN (good for filtering on association)

## Prevention

- Enable Bullet gem in development to catch N+1 queries early
- Add test assertions for query count: `assert_queries(2) { User.with_profile.to_a }`
- Default to eager loading in scopes used by controllers
- Review any `each` loop accessing associations

## Related Issues

No related issues documented yet.
