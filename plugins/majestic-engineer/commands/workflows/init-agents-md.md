---
name: majestic:init-agents-md
description: Initialize AGENTS.md with hierarchical structure and .agents.yml config
allowed-tools: AskUserQuestion, Skill, Bash, Write, Read, Grep, Glob
---

# Initialize AGENTS.md

Set up AI agent documentation and machine-readable config for this project.

## Architecture

- **AGENTS.md** - Human-readable guidance (WHAT/WHY/HOW)
- **.agents.yml** - Machine-readable config for commands
- **CLAUDE.md** - Symlink to AGENTS.md

## AGENTS.md Best Practices

### Constraints

| Constraint | Reason |
|------------|--------|
| **Under 300 lines** | Ideally 60-100 for simple projects |
| **~150 instruction limit** | Claude Code's system prompt uses ~50 |
| **Universal rules only** | Non-universal instructions get ignored |
| **No config data** | Config belongs in `.agents.yml` |

### The WHAT/WHY/HOW Framework

```markdown
# Project Name

Load config: @.agents.yml

## WHAT (Architecture)
- Tech stack, project structure
- Major directories and their purpose

## WHY (Purpose)
- What this project does
- Where to find relevant code

## HOW (Workflows)
- Essential commands (build, test, lint)
- Verification procedures
```

## Step 1: Generate AGENTS.md

Invoke the hierarchical-agents skill to analyze the codebase:

```
skill hierarchical-agents
```

Follow the skill's process, then verify line count:
```bash
wc -l AGENTS.md
```

## Step 2: Gather Configuration

Use `AskUserQuestion` to gather ALL config in one consolidated question set:

### Question 1: Tech Stack
**Question:** "What is the primary tech stack?"
**Options:**
1. **Rails** - Ruby on Rails
2. **Python** - Python (FastAPI, Django, etc.)
3. **Generic** - Other or auto-detect

### Question 2: App Status
**Question:** "What is the application's current status?"
**Options:**
1. **Development** - Pre-production, breaking changes OK
2. **Production** - Live users, backward compatibility required

### Question 3: Task Management
**Question:** "What task management system do you use?"
**Options:**
1. **GitHub Issues**
2. **Linear**
3. **Beads**
4. **File-based** (docs/backlog/)
5. **None**

### Question 4: Workflow
**Question:** "How do you prefer to work on features?"
**Options:**
1. **Worktrees** - Isolated directories per feature
2. **Branches** - Traditional feature branches

### Question 5: Branch Naming
**Question:** "What branch naming convention?"
**Options:**
1. **feature/desc** - e.g., `feature/add-auth`
2. **issue-desc** - e.g., `42-add-auth`
3. **type/issue-desc** - e.g., `feat/42-add-auth`
4. **user/desc** - e.g., `david/add-auth`

### Question 6: Review Topics
**Question:** "Where should code review topics be stored?"
**Options:**
1. **Default** - `docs/agents/review-topics.md`
2. **Skip** - Don't configure now

### Question 7: Track in Git?
**Question:** "Should `.agents.yml` be tracked in git?"
**Options:**
1. **Yes** - Shared config for team
2. **No** - Local-only (add to .gitignore)

## Step 3: Auto-Detect Values

### Default Branch

```bash
# Try remote HEAD first
git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@'

# Fallback: check for main
git show-ref --verify refs/heads/main 2>/dev/null && echo "main"

# Fallback: check for master
git show-ref --verify refs/heads/master 2>/dev/null && echo "master"
```

Use first successful result, default to `main`.

### Tech Stack (if Generic selected)

```bash
[ -f Gemfile ] && echo "rails"
[ -f pyproject.toml ] || [ -f requirements.txt ] && echo "python"
```

## Step 4: Write .agents.yml

Create the config file with ALL gathered values:

```yaml
# .agents.yml - Project configuration for Claude Code commands
# Generated by /majestic:init-agents-md

default_branch: main
tech_stack: rails
app_status: development
task_management: github
workflow: worktrees
branch_naming: type/issue-desc
review_topics_path: docs/agents/review-topics.md
```

Only include `review_topics_path` if user selected Default (not Skip).

If user selected "No" for git tracking:
```bash
echo ".agents.yml" >> .gitignore
```

## Step 5: Update AGENTS.md

Add config reference at the top of AGENTS.md, right after the title:

```markdown
# Project Name

Load config: @.agents.yml
```

Remove any existing config sections from AGENTS.md (tech_stack, review_topics_path, etc.) - all config now lives in `.agents.yml`.

## Step 6: Create Review Topics File

If user selected Default for review topics, create the file:

```bash
mkdir -p docs/agents
```

Write `docs/agents/review-topics.md`:

```markdown
# Code Review Topics

Project-specific topics checked during every code review.

### Example Category
- Example topic to always check
- Another important convention

<!--
Tips:
- Be specific: "API calls need 30s timeout" not "handle errors"
- Focus on project-specific rules, not general best practices
-->
```

## Step 7: Create CLAUDE.md Symlink

```bash
ln -s AGENTS.md CLAUDE.md
```

**If CLAUDE.md exists**, ask:
1. **Replace** - Backup to CLAUDE.md.bak, then symlink
2. **Skip** - Leave as-is

## Step 8: Final Verification

```bash
# Check AGENTS.md line count
wc -l AGENTS.md

# Verify .agents.yml
cat .agents.yml

# Verify symlink
ls -la CLAUDE.md
```

## Output Summary

```
✅ AGENTS.md initialized
   - Line count: X lines
   - Config reference added

✅ .agents.yml created
   - default_branch: main
   - tech_stack: rails
   - app_status: development
   - task_management: github
   - workflow: worktrees
   - branch_naming: type/issue-desc
   - review_topics_path: docs/agents/review-topics.md

✅ CLAUDE.md symlink created

⚠️  Remember: Review and refine AGENTS.md manually
```
